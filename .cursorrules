# DATERP - Architectural & Behavioral Rules for Antigravity

You are working on **DATERP**, an **ABP-based Modular ERP Platform** designed for Education (Language Centers, IT Centers, Schools) and Enterprise resource planning.

## 1. Architectural Principles (Non-negotiable)
- **Architecture**: Strict **ABP Modular Monolith**.
- **Core System (`src/`)**: Contains ONLY shared infrastructure and host applications. **NO** business logic specific to a module (like specific exam rules or course management) goes here.
- **Business Modules (`modules/`)**: ALL business logic must be encapsulated in standalone ABP Modules (e.g., `modules/Academic`, `modules/LMS`).
    - Modules must be designed to be potentially separable (microservice-ready) in the future.
    - Modules interact via **Contracts** (Interfaces/DTOs) and Events, never direct database joining across module distinct contexts unless explicitly architected via Shared Kernel.
- **Themes (`themes/`)**: UI styling and layout logic belong in Theme Modules. `src/DATERP.Web` is just the host to mount the theme.

## 2. Directory Structure Rules
- `src/`: **Infrastructure Layer**.
    - `DATERP.Domain.Shared`: Enums, Consts shared globally (e.g., Roles).
    - `DATERP.HttpApi.Host`: The main API entry point.
    - `DATERP.Web`: This is the **Application Shell**. It hosts modules but contains little UI logic itself.
- `modules/`: **Business Layer**.
    - `Academic`: Management of Classes, Schedules, Students, Centers.
    - `LMS`: Courses, Lessons, Enrollments, Progress tracking.
    - `Examination`: Tests, Questions, Results, Certificates.
    - `Finance`, `HR`, `CRM`, `Inventory`, `Reporting`: Respective domains.
- `themes/`: **Presentation Layer**.
    - `DATERP.Theme.Education`: Main theme for the education platform.

## 3. Technology Stack & Standards
- **Framework**: .NET 9.0 + ABP Framework (v9.x).
- **Frontend**: ASP.NET Core MVC (Razor Views) + Standard ABP UI libraries.
- **Database**: SQL Server (Entity Framework Core).
- **Identity**: ABP Identity Module (Roles: Admin, Teacher, Student, Staff, Accountant).

## 4. Coding & Implementation Guidelines

### 4.1. Domain Layer (DDD)
- **Entities**: MUST inherit from `AggregateRoot<Guid>` or `Entity<Guid>`. Use `FullAuditedAggregateRoot<Guid>` for important business data.
- **Managers**: Use `DomainService` for complex business logic involving multiple entities.
- **Constructors**: Always enforce invariants via `protected`/`private` constructors and Static Factory Methods or standard constructors.
- **Repository Usage**:
    - Use `IRepository<TEntity, Guid>` for standard CRUD.
    - Use `IQueryable<TEntity>` (via `GetQueryableAsync`) inside Domain Services or custom repositories for complex queries.
    - **NEVER** return `IQueryable` from Application Services.

### 4.2. Application Layer
- **Services**: Inherit from `ApplicationService`.
- **DTOs**:
    - `CreateUpdate...Dto` for writing data.
    - `...Dto` for reading data.
    - Use `ObjectMapper` for Entity -> DTO conversion.
- **Validation**: Use Data Annotations only for simple rules. Use FluentValidation (`AbstractValidator<T>`) for complex rules.
- **Authorization**: Apply `[Authorize(PermissionNames.MyPermission)]` at the Class or Method level in AppServices.

### 4.3. Database (EF Core)
- **Configuration**: Use `IEntityTypeConfiguration<T>` in `DbContextModelCreatingExtensions`.
- **Migrations**: Always run `dotnet ef migrations add` in `src/DATERP.EntityFrameworkCore` (or module specific EF projects if separated) when Domain changes.

### 4.4. Frontend (MVC)
- **Page Models**: Inherit from `AbpPageModel`.
- **Modals**: use `abp-modal` tag helpers.
- **JavaScript**: Use `abp.ajax`, `abp.notify`, `abp.message` standard APIs.

## 5. Workflow Trigger
- If asked to "Add a feature" (e.g., "Add student management"):
    1.  Identify the correct module (e.g., `modules/Academic`).
    2.  If the module doesn't exist structurally, initialize it first.
    3.  Implement implementing Domain -> EF Core -> Application -> Web layers within that module folder.
    4.  **DO NOT** add it to `src/DATERP.Application`.

## 6. Agent Behavior
- **Proactive Check**: Before implementing code, verify which module directory defines the context.
- **Module Isolation**: Assume modules cannot access each other's DbContexts directly. Use Repositories or Events.
- **Refactoring**: If you see business logic in `src/`, propose moving it to `modules/`.